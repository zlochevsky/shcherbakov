{{- $path := printf "texts/%s.txt" .id -}}
{{- $pageParams := . -}}
{{- $linesText := slice -}}
{{- $linesSide := slice -}}
{{- $linesAbove := slice -}}
{{- $linesHeader := slice -}}
{{- $newLinesAfter := slice -}}
{{- $tonality := "Hm" -}}
{{- $stressLine := "" -}}
{{- $hasStress := false -}}
{{- $lastNonEmptyIndex := 0 -}}
{{- with resources.Get $path -}}
    {{- $cont := .Content -}}
    {{- if and (isset $pageParams "tonality") (ne $pageParams.tonality "") -}}
        {{- $tonality = $pageParams.tonality -}}
    {{- else -}}
        {{- $reg := `(?s)[A-H][b\#]?(2|4|5|6|7|9|11|13|6\/9|7\-5|7\-9|7\#5|7\#9|7\+5|7\+9|b5|#5|#9|7b5|7b9|7sus2|7sus4|add2|add4|add9|aug|dim|dim7|m\/maj7|m6|m7|m7b5|m9|m11|m13|maj7|maj9|maj11|maj13|mb5|m|sus|sus2|sus4)*(\/[A-H][b\#]*)*` -}}
        {{- $tonality = delimit ( findRE $reg $cont 1 ) "" -}}
    {{- end -}}
    {{- $lines := split $cont "\n" -}}
    {{- $lines = apply $lines "trim" "." "\r" -}}{{/* remove \r from all lines */}}
    {{/* last line index */}}
    {{- $lastIndex := math.Sub (len $lines) 1 -}}
    {{/* determine last non-empty line index (used to detect year line) */}}
    {{- range $k, $v := $lines -}}
        {{- if gt (len (trim $v " \t")) 0 -}}
            {{- $lastNonEmptyIndex = $k -}}
        {{- end -}}
    {{- end -}}
    {{/* chords start position (clamped to 0) */}}
    {{- $pos := int ( math.Max 0 (sub (int $pageParams.chordsStartAt)  1) ) -}}
    {{- range $k, $v := $lines -}}
        {{- $line := $v -}}
        {{- if (and (lt $k 2) (hasPrefix (lower $line) (lower $pageParams.title) ) ) -}}
            {{/* wrap title in <h1> */}}
	        {{- $line = print "<h1>" $line "</h1>" -}}
            {{- $linesHeader = $linesHeader | append (println $line | safeHTML) -}}
        {{- else -}}
            {{/* non-empty lines */}}
            {{- if gt (len (trim $line " \t")) 0 -}}
                {{/* determine if line should have year wrapped (skip first 2 lines) */}}
                {{- $shouldWrapYear := false -}}
                {{- if ge $k 2 -}}
                    {{- if eq $k $lastNonEmptyIndex -}}
                        {{- $shouldWrapYear = true -}}
                    {{- else if $pageParams.textFinishAtLine -}}
                        {{- $textFinish := int $pageParams.textFinishAtLine -}}
                        {{- if and (ge $k (sub $textFinish 6)) (le $k $textFinish) -}}
                            {{- $shouldWrapYear = true -}}
                        {{- end -}}
                    {{- end -}}
                {{- end -}}
                {{/* wrap year in <span> using Regex */}}
                {{- if $shouldWrapYear -}}
                    {{- $line = replaceRE `^\s*(<?\s*\d{4}(?:,\s*\d{4})*\s*>?)\s*$` "<span class=\"year\">$1</span>" $line -}}
                {{- end -}}
                {{- if (ge $k $pageParams.textFinishAtLine)  -}}
                    {{/* add lines to $newLinesAfter for <pre> block) */}}
                    {{- $newLinesAfter = $newLinesAfter | append (println $line | safeHTML ) -}}
                {{- else -}}
                    {{- if gt $pos 0 -}}
                        {{/* split line into text and chords at position */}}
                        {{- if and (gt (len $line) $pos) ( gt (len (findRE `[A-Ha-hm#0-9]+` $line)) 0) -}}
                            {{- $p1 := substr $line 0 $pos -}}{{/* text substring */}}
                            {{- $p2 := substr $line $pos -}}{{/* chords substring */}}
                            {{- $stressPositions := "" -}}
                            {{- if ne $stressLine "" -}}
                                {{/* parse stress positions from previous line */}}
                                {{- $positions := slice -}}
                                {{- $chars := split $stressLine "" -}}
                                {{- range $i, $c := $chars -}}
                                    {{- if eq $c "," -}}
                                        {{- $positions = $positions | append $i -}}
                                    {{- end -}}
                                {{- end -}}
                                {{- $stressPositions = delimit $positions "," -}}
                                {{- $stressLine = "" -}}
                            {{- end -}}
                            {{/* append text and chords to view arrays */}}
                            {{- $dataAttr := cond (ne $stressPositions "") (printf " data-positions=\"%s\"" $stressPositions) "" -}}
                            {{- $linesSide = $linesSide | append (print "<span class=\"txt\">" $p1 "</span><span class=\"ch\">" $p2 "</span><br>\n" | safeHTML) -}}
                            {{- $linesAbove = $linesAbove | append (printf "<span class=\"ch\"%s>%s</span><br>\n<span class=\"txt\">%s</span><br>\n" $dataAttr (cond (not $hasStress) (strings.TrimLeft " " $p2) $p2) (strings.TrimRight " " $p1) | safeHTML) -}}
                            {{- $linesText = $linesText | append (print "<span class=\"txt\">" $p1 "</span>\n" | safeHTML) -}}
                        {{- else -}}
                            {{- if findRE `^[\s,\|0-9]+$` $line -}}
                                {{/* save stress line for next iteration, add to side view */}}
                                {{- $stressLine = $line -}}
                                {{- $hasStress = true -}}
                                {{- $linesSide = $linesSide | append (print "<span class=\"strss\">" (replaceRE ` +$` "" $line) "<br></span>\n" | safeHTML) -}}
                            {{- else -}}
                                {{/* text-only line: trim trailing spaces, append to all views */}}
                                {{- $linesSide = $linesSide | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}
                                {{- $linesAbove = $linesAbove | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}
                                {{- $linesText = $linesText | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span>\n" | safeHTML) -}}
                            {{- end -}}
                        {{- end -}}
                    {{- else -}}
                        {{/* $pos == 0: detect if line is chords-only or text */}}
                        {{- if findRE `^\s*(?:[1-6]?[A-Ha-h][b#]?(?:2|4|5|6|7|9|11|13|6\/9|7-5|7-9|7#5|7#9|7\+5|7\+9|b5|#5|#9|7b5|7b9|7sus2|7sus4|add2|add4|add9|aug|dim|dim7|m\/maj7|m6|m7|m7b5|m9|m11|m13|maj7|maj9|maj11|maj13|mb5|m|sus|sus2|sus4)?(?:\/[1-6]?[A-Ha-h][b#]?(?:-[1-6]?[A-Ha-h][b#]?)*)?(?:\s+|$))+$` $line -}}
                            {{/* chords only */}}
                            {{- $linesSide = $linesSide | append (print "<span class=\"ch\">" $line "</span><br>\n" | safeHTML) -}}
                            {{- $linesAbove = $linesAbove | append (print "<span class=\"ch\">" $line "</span><br>\n" | safeHTML) -}}
                        {{- else -}}
                            {{/* text line */}}
                            {{- $linesSide = $linesSide | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}
                            {{- $linesAbove = $linesAbove | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}
                            {{- $linesText = $linesText | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span>\n" | safeHTML) -}}
                        {{- end -}}
                    {{- end -}}
                {{- end -}}
            {{- else -}}
                {{/* process empty lines */}}
                {{- if  (le $k $pageParams.textFinishAtLine) -}}
                    {{- $linesSide = $linesSide | append "<br>\n" -}}
                    {{- $linesAbove = $linesAbove | append "<br>\n" -}}
                    {{- $linesText = $linesText | append "\n" -}}
                {{- else -}}
                    {{- $newLinesAfter = $newLinesAfter | append "\n" -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

{{- else -}}
    {{- $linesSide = $linesSide | append (printf "Файл с аккордами не найден (%s)" .id) -}}
    {{- $linesAbove = $linesAbove | append (printf "Файл с аккордами не найден (%s)" .id) -}}
    {{- $linesText = $linesText | append (printf "Файл с текстом не найден (%s)" .id) -}}
{{- end -}}




<div class="view-container viewtype-source">
    {{- with resources.Get $path -}}
        <pre>
            {{- .Content -}}
        </pre>    
    {{- end -}}
</div>
<div class="view-container viewtype-text">
{{- delimit $linesHeader "" | safeHTML -}}
<pre>
    {{- delimit $linesText "" | safeHTML -}}
</pre>
</div>
<div class="view-container viewtype-side  song" data-key="{{- $tonality -}}" data-has-stress="{{- $hasStress -}}">
{{- delimit $linesHeader "" | safeHTML -}}
{{- delimit $linesSide "" | safeHTML -}}
<pre>
    {{- delimit $newLinesAfter "" | safeHTML -}}
</pre>
</div>
<div class="view-container viewtype-above song" data-key="{{- $tonality -}}">
{{- delimit $linesHeader "" | safeHTML -}}
{{- delimit $linesAbove "" | safeHTML -}}
<pre>
    {{- delimit $newLinesAfter "" | safeHTML -}}
</pre>
</div>