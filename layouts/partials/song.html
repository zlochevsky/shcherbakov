{{- $path := printf "texts/%s.txt" .id -}}
{{- $pageParams := . -}}
{{- $linesText := slice -}}
{{- $linesSide := slice -}}
{{- $linesAbove := slice -}}
{{- $linesHeader := slice -}}
{{- $newLinesAfter := slice -}}
{{- $tonality := "Hm" -}}
{{- $stressLine := "" -}}
{{- $hasStress := false -}}
{{- with resources.Get $path -}}
    {{- $cont := .Content -}}
    {{- if and (isset $pageParams "tonality") (ne $pageParams.tonality "") -}}
        {{- $tonality = $pageParams.tonality -}}
    {{- else -}}
        {{- $reg := `(?s)[A-H][b\#]?(2|4|5|6|7|9|11|13|6\/9|7\-5|7\-9|7\#5|7\#9|7\+5|7\+9|b5|#5|#9|7b5|7b9|7sus2|7sus4|add2|add4|add9|aug|dim|dim7|m\/maj7|m6|m7|m7b5|m9|m11|m13|maj7|maj9|maj11|maj13|mb5|m|sus|sus2|sus4)*(\/[A-H][b\#]*)*` -}}
        {{- $tonality = delimit ( findRE $reg $cont 1 ) "" -}}
    {{- end -}}
    {{- $lines := split $cont "\n" -}}{{/* массив строк $lines из $cont разбитого по \n */}}
    {{- $lastIndex := math.Sub (len $lines) 1 -}}{{/* rebase to 0-based */}}
    {{- $lastNonEmptyIndex := 0 -}}

    {{- range $k, $v := $lines -}}
        {{- if gt (len (trim $v " \t\r\n")) 0 -}}
            {{- $lastNonEmptyIndex = $k -}}
        {{- end -}}
    {{- end -}}

    {{- $pos := int ( math.Max 0 (sub (int $pageParams.chordsStartAt)  1) ) -}}{{/* позиция старта аккордов в строке (с защитой от отриц.) */}}

    {{- range $k, $v := $lines -}}{{/* проход по строкам */}}
        {{- $line := cond (lt $k $pageParams.textFinishAtLine) (trim $v "\r\n") $v -}}{{/* удаление знаков конца строк */}}
        {{- if (and (lt $k 2) (hasPrefix (lower $line) (lower $pageParams.title) ) ) -}}{{/* если строка первая или вторая и начинается с title */}}
	        {{- $line = print "<h1>" $line "</h1>" -}}
            {{- $linesHeader = $linesHeader | append (println $line | safeHTML) -}}{{/* выводим H1 */}} 
        {{- else -}}
            {{- if gt (len (trim $line " \t")) 0 -}}{{/* если непустые строки */}}
                {{- $shouldWrapYear := false -}}{{/* Проверяем, является ли строка строкой с годом (делаем это ПЕРЕД проверкой textFinishAtLine) */}}
                {{- if ge $k 2 -}}{{/* пропускаем первые 2 строки (заголовок) */}}
                    {{- if eq $k $lastNonEmptyIndex -}}{{/* последняя непустая строка */}}
                        {{- $shouldWrapYear = true -}}
                    {{- else if $pageParams.textFinishAtLine -}}
                        {{- $textFinish := int $pageParams.textFinishAtLine -}}
                        {{- if and (ge $k (sub $textFinish 6)) (le $k $textFinish) -}}{{/* Проверяем диапазон вокруг textFinishAtLine (line number is 1-based, $k is 0-based) */}}
                            {{- $shouldWrapYear = true -}}
                        {{- end -}}
                    {{- end -}}
                {{- end -}}
                {{- if $shouldWrapYear -}}
                    {{- $line = replaceRE `(<?\s*\d{4}(?:,\s*\d{4})*\s*>?)` "<span class=\"year\">$1</span>" $line -}}{{/* год (через зпт и в угл.) */}}
                {{- end -}}{{/* проверяем, должна ли строка идти в $newLinesAfter (после обёртки года) */}}
                {{- if (or (ge $k $pageParams.textFinishAtLine) (eq $k $lastIndex)) -}}{{/* если $k >= $textFinishAtLine или это последняя строка текста */}}
                    {{- $newLinesAfter = $newLinesAfter | append (println $line | safeHTML ) -}}{{/* добавляем строку в $newLinesAfter + перевод строки */}}
                {{- else -}}
                    {{- if gt $pos 0 -}}{{/* если $pos > 0 */}}
                        {{- if and (gt (len $line) $pos) ( gt (len (findRE `[A-Ha-hm#0-9]+` $line)) 0) -}}{{/* если строка длиннее $pos и в ней найдены аккорды */}}
                            {{- $p1 := substr $line 0 $pos -}}{{/* формирует первую подстроку до $pos */}}
                            {{- $p2 := substr $line $pos -}}{{/* формирует вторую подстроку от $pos */}}
                            {{- $p2 = replaceRE `->` "&#151;&gt;" $p2 -}}{{/* знак "->"  */}}
                            {{- $stressPositions := "" -}}
                            {{- if ne $stressLine "" -}}{{/* если в предыдущей строке были найдены ударения */}}
                                {{- $positions := slice -}}
                                {{- $chars := split $stressLine "" -}}
                                {{- range $i, $c := $chars -}}
                                    {{- if eq $c "," -}}
                                        {{- $positions = $positions | append $i -}}
                                    {{- end -}}
                                {{- end -}}
                                {{- $stressPositions = delimit $positions "," -}}
                                {{- $stressLine = "" -}}{{/* обнуляем переменную после использования */}}
                            {{- end -}}
                            {{- $dataAttr := cond (ne $stressPositions "") (printf " data-positions=\"%s\"" $stressPositions) "" -}}
                            {{- $linesSide = $linesSide | append (print "<span class=\"txt\">" $p1 "</span><span class=\"ch\">" $p2 "</span><br>\n" | safeHTML) -}}
                            {{- $linesAbove = $linesAbove | append (printf "<span class=\"ch\"%s>%s</span><br>\n<span class=\"txt\">%s</span><br>\n" $dataAttr $p2 (strings.TrimRight " " $p1) | safeHTML) -}}
                            {{- $linesText = $linesText | append (print "<span class=\"txt\">" $p1 "</span>\n" | safeHTML) -}}
                        {{- else -}}
                            {{- if findRE `^[\s,]+$` $line -}}
                                {{- $stressLine = $line -}}
                                {{- $hasStress = true -}}
                                {{- $linesSide = $linesSide | append (print "<span class=\"strss\">" (replaceRE ` +$` "" $line) "<br></span>\n" | safeHTML) -}}
                            {{- else -}}
                                {{- $linesSide = $linesSide | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}{{/* добавл строки в срез $newLines, в .txt */}}
                                {{- $linesAbove = $linesAbove | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span><br>\n" | safeHTML) -}}
                                {{- $linesText = $linesText | append (print "<span class=\"txt\">" (replaceRE ` +$` "" $line) "</span>\n" | safeHTML) -}}
                            {{- end -}}
                        {{- end -}}
                    {{- else -}}
                        {{- $linesSide = $linesSide | append (print "<span class=\"ch\">" $line "</span>\n" | safeHTML) -}}
                        {{- $linesAbove = $linesAbove | append (print "<span class=\"ch\">" $line "</span>\n" | safeHTML) -}}
                    {{- end -}}
                {{- end -}}
            {{- else -}}
                {{- if  (le $k $pageParams.textFinishAtLine) -}}
                    {{- $linesSide = $linesSide | append "<br>\n" -}}
                    {{- $linesAbove = $linesAbove | append "<br>\n" -}}
                    {{- $linesText = $linesText | append "\n" -}}
                {{- end -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}
{{- else -}}{{- $linesSide = $linesSide | append (printf "Файл с аккордами не найден (%s)" .id) -}}
    {{- $linesAbove = $linesAbove | append (printf "Файл с аккордами не найден (%s)" .id) -}}
    {{- $linesText = $linesText | append (printf "Файл с текстом не найден (%s)" .id) -}}
{{- end -}}
<div class="view-container viewtype-source">
    {{- with resources.Get $path -}}
        <pre>
            {{- .Content -}}
        </pre>    
    {{- end -}}
</div>
<div class="view-container viewtype-text">
{{- delimit $linesHeader "" | safeHTML -}}<pre>{{- delimit $linesText "" | safeHTML -}}</pre>
</div>
<div class="view-container viewtype-side  song" data-key="{{- $tonality -}}" data-has-stress="{{- $hasStress -}}">
{{- delimit $linesHeader "" | safeHTML -}}
{{- delimit $linesSide "" | safeHTML -}}<pre>{{- delimit $newLinesAfter "" | safeHTML -}}</pre>
</div>
<div class="view-container viewtype-above" data-key="{{- $tonality -}}">
{{- delimit $linesHeader "" | safeHTML -}}{{- delimit $linesAbove "" | safeHTML -}}<pre>{{- delimit $newLinesAfter "" | safeHTML -}}</pre>
</div>